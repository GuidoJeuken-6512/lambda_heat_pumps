name: Generate changelog pages

on:
  push:
    paths:
      - 'CHANGELOG.md'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      TARGET_BRANCH: ${{ github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate changelog pages
        run: |
          python - <<'PY'
          import re, os
          src = "CHANGELOG.md"
          out_en = "docs_src/en/changelog.md"
          out_de = "docs_src/de/changelog.md"
          text = open(src, encoding="utf-8").read() if os.path.exists(src) else ""
          def extract(text):
              # first try HTML comment markers
              found = {}
              for code in ("en","de"):
                  start = f"<!-- lang:{code} -->"
                  end = f"<!-- /lang:{code} -->"
                  if start in text and end in text:
                      found[code] = text.split(start,1)[1].split(end,1)[0].strip()
              if found:
                  return found
              # then try language headings
              lang_heading_re = re.compile(r'^(#{1,6})\s*(?P<name>english|eng|en|deutsch|german|de)\b.*$', re.I | re.M)
              matches = list(lang_heading_re.finditer(text))
              if matches:
                  for i, m in enumerate(matches):
                      name = m.group('name').lower()
                      code = 'en' if name.startswith('en') else 'de'
                      startpos = m.end()
                      endpos = matches[i+1].start() if i+1 < len(matches) else len(text)
                      found.setdefault(code, '')
                      found[code] += text[startpos:endpos].strip() + "\n\n"
                  return found
              # fallback - return full text for both
              return {'en': text, 'de': text}
          parts = extract(text)
          os.makedirs(os.path.dirname(out_en), exist_ok=True)
          os.makedirs(os.path.dirname(out_de), exist_ok=True)
          def ensure_header(md, lang):
              if not re.search(r'^\s*#\s+', md, re.M):
                  title = "# Changelog\n\n" if lang=='en' else "# Ã„nderungsprotokoll\n\n"
                  return title + md
              return md
          open(out_en,"w",encoding="utf-8").write(ensure_header(parts.get('en',''), 'en').strip()+"\n")
          open(out_de,"w",encoding="utf-8").write(ensure_header(parts.get('de',''), 'de').strip()+"\n")
          print('Generated:', out_en, out_de)
          PY

      - name: Commit & push generated pages (if changed)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs_src/en/changelog.md docs_src/de/changelog.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(docs): update generated changelog pages"
            git push origin HEAD
          fi
